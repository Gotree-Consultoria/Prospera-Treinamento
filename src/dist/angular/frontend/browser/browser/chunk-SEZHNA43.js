import{a as O}from"./chunk-QH4O4DEC.js";import{a as A,b as h,c as P,d as R}from"./chunk-ISAQG44I.js";import{O as E,S as U,a as b,n as C,o as m,r as a,y as k,z as g}from"./chunk-REX2TJ7H.js";var z=class v{constructor(e,n){this.api=e;this.http=n}getSectors(){return this.api.get("/admin/sectors").pipe(a(e=>this.unwrapList(e).map(this.normalizeSector)))}getOrganizations(){return this.api.get("/admin/organizations").pipe(a(e=>this.unwrapList(e).map(n=>this.normalizeOrganization(n))))}getOrganizationById(e){return this.api.get(`/admin/organizations/${encodeURIComponent(e)}`).pipe(a(n=>this.normalizeOrganization(n)))}updateOrganizationEnabled(e,n){let i=n?"ACTIVE":"INACTIVE";return this.api.patch(`/admin/organizations/${encodeURIComponent(e)}/status`,{newStatus:i}).pipe(g(r=>r&&(r.status===400||r.status===404||r.status===405)?this.api.patch(`/admin/organizations/${encodeURIComponent(e)}`,{enabled:n}):m(()=>r)))}getUsers(){return this.api.get("/admin/users").pipe(a(e=>this.unwrapList(e).map(n=>this.normalizeUser(n))))}getUserById(e){return this.api.get(`/admin/users/${encodeURIComponent(e)}`).pipe(a(n=>this.normalizeUser(n)))}updateUserEnabled(e,n){return this.api.patch(`/admin/users/${encodeURIComponent(e)}`,{enabled:n}).pipe(g(i=>{if(i&&(i.status===400||i.status===404||i.status===405)){let r=n?"ACTIVE":"INACTIVE";return this.api.patch(`/admin/users/${encodeURIComponent(e)}/status`,{newStatus:r})}return m(()=>i)}))}createSector(e){return this.api.post("/admin/sectors",{name:e}).pipe(a(this.normalizeSector))}deleteSector(e){return this.api.delete(`/admin/sectors/${encodeURIComponent(e)}`).pipe(a(()=>{}))}getSectorById(e){return this.api.get(`/admin/sectors/${encodeURIComponent(e)}`).pipe(a(this.normalizeSector))}getTrainings(){return this.api.get("/admin/trainings").pipe(a(e=>this.unwrapList(e).map(this.normalizeTraining)))}createTraining(e){return this.api.post("/admin/trainings",e).pipe(a(this.normalizeTraining))}getTrainingById(e){return this.api.get(`/admin/trainings/${encodeURIComponent(e)}`).pipe(a(this.normalizeTraining))}updateTraining(e,n){return this.api.put(`/admin/trainings/${encodeURIComponent(e)}`,n).pipe(a(this.normalizeTraining))}publishTraining(e){return this.api.post(`/admin/trainings/${encodeURIComponent(e)}/publish`,{}).pipe(a(()=>{}))}deleteTraining(e){return this.api.delete(`/admin/trainings/${encodeURIComponent(e)}`).pipe(a(()=>{}))}assignTrainingToSector(e,n){return this.api.post(`/admin/trainings/${encodeURIComponent(e)}/sectors`,n).pipe(a(()=>{}))}unlinkTrainingSector(e,n){return this.api.delete(`/admin/trainings/${encodeURIComponent(e)}/sectors/${encodeURIComponent(n)}`).pipe(a(()=>{}))}orgUnfollowSector(e,n){return this.api.delete(`/organizations/${encodeURIComponent(e)}/sectors/${encodeURIComponent(n)}`).pipe(a(()=>{}))}uploadEbookFile(e,n){let i=new FormData;return i.append("file",n),this.api.post(`/admin/trainings/ebooks/${encodeURIComponent(e)}/upload`,i)}uploadEbookFileWithProgress(e,n){let i=new FormData;i.append("file",n);let r=this.api.createUrl(`/admin/trainings/ebooks/${encodeURIComponent(e)}/upload`),o=new A("POST",r,i,{reportProgress:!0});return this.http.request(o).pipe(a(t=>t.type===h.UploadProgress?{type:"progress",progress:t.total?Math.round(t.loaded/t.total*100):0}:t.type===h.Response?{type:"response",body:t.body??null}:null),k(t=>t!==null),g(t=>{let c=t instanceof P&&t.message||"Falha no upload do e-book.";return m(()=>new Error(c))}))}uploadTrainingCoverImage(e,n){let i=new FormData;i.append("file",n);let r=this.api.createUrl(`/admin/trainings/${encodeURIComponent(e)}/cover-image`),o=new A("POST",r,i,{reportProgress:!0});return this.http.request(o).pipe(a(t=>t.type===h.UploadProgress?{type:"progress",progress:t.total?Math.round(t.loaded/t.total*100):0}:t.type===h.Response?{type:"response",body:t.body??null}:null),k(t=>t!==null),g(t=>m(()=>new Error(t?.message||"Falha no upload da capa."))))}fetchEbookProgress(e){return this.api.get(`/progress/ebooks/${encodeURIComponent(e)}`).pipe(g(n=>n instanceof P&&n.status===404?C(null):m(()=>n)))}updateEbookProgress(e,n){return this.api.put(`/progress/ebooks/${encodeURIComponent(e)}`,{lastPageRead:n}).pipe(a(()=>{}))}buildEbookFileUrl(e){return e?this.api.createUrl(`/admin/ebooks/${encodeURIComponent(e)}`):null}trainingHasPdf(e){return this.trainingPdfDebug(e).has}trainingPdfDebug(e){if(!e)return{has:!1,matchedBy:"no-training"};let n=new Set,i=e,r=d=>{if(typeof d!="string")return!1;let s=d.trim();return!!(s.split("?")[0].trim().toLowerCase().endsWith(".pdf")||/\.pdf($|\?)/i.test(s))},o=["hasPdf","pdfUploaded","ebookFileUploaded","fileUploaded"];for(let d of o)if(i&&i[d])return{has:!0,matchedBy:"boolean-flag",key:d,valueSample:String(i[d])};let t=i.ebookDetails;if(t&&typeof t=="object"){let s=[t.filePath,t.file,t.filepath,t.pdfFilePath,t.pdfPath,t.url,t.fileUrl,t.name,t.filename,t.originalName].find(f=>r(f));if(s)return{has:!0,matchedBy:"ebookDetails",key:"ebookDetails.*",valueSample:String(s)}}let c=["filePath","filepath","file","pdfPath","pdfFilePath","pdfFile","ebookFile","ebookFilePath","ebookPath","ebookPdfPath","ebookFileUrl","fileUrl","pdfUrl","pdf","ebookUrl","ebook","document","documentPath","resourcePath","resourceUrl","pdfFileName","ebookFileName","filename","name","originalName"];for(let d of c){let s=i[d];if(r(s))return{has:!0,matchedBy:"direct-key",key:d,valueSample:String(s)}}let p=[{value:i,depth:0,path:"root"}],w=5,F=500,I=0;for(;p.length;){let d=p.shift(),{value:s,depth:f,path:y}=d;if(!s||typeof s!="object"||n.has(s))continue;if(n.add(s),I++,I>F)break;let $=Array.isArray(s)?s.map((u,l)=>[String(l),u]):Object.entries(s);for(let[u,l]of $){if(r(l))return{has:!0,matchedBy:"deep-scan",key:u,valueSample:String(l),path:y+"."+u};if(l&&typeof l=="object"&&!Array.isArray(l)){let S=l.name||l.fileName||l.filename||l.originalName,T=l.url||l.fileUrl;if(r(S))return{has:!0,matchedBy:"deep-file-object-name",key:u,valueSample:String(S),path:y+"."+u};if(r(T))return{has:!0,matchedBy:"deep-file-object-url",key:u,valueSample:String(T),path:y+"."+u}}l&&typeof l=="object"&&f<w&&p.push({value:l,depth:f+1,path:y+"."+u})}}return{has:!1,matchedBy:"not-found"}}extractPdfFileName(e){if(!e)return"";let n=o=>{if(typeof o!="string")return!1;let t=o.trim();return!!(t.split("?")[0].trim().toLowerCase().endsWith(".pdf")||/\.pdf($|\?)/i.test(t))},i=["filePath","filepath","file","pdfPath","pdfFilePath","pdfFile","ebookFile","ebookFilePath","ebookPath","ebookPdfPath","ebookFileUrl","fileUrl","pdfUrl","pdf","ebookUrl"];for(let o of i){let t=e[o];if(n(t))try{return decodeURIComponent(t.split("/").pop().split("?")[0])}catch{return t.split("/").pop()??""}}let r=e.ebookDetails;if(r&&n(r.filePath))try{return decodeURIComponent(r.filePath.split("/").pop().split("?")[0])}catch{return r.filePath.split("/").pop()??""}return""}extractPdfUpdatedDate(e){if(!e)return null;let n=["pdfUpdatedAt","fileUpdatedAt","ebookUpdatedAt","ebookFileUpdatedAt","updatedAt","lastUpdatedAt","modifiedAt","fileModifiedAt"];for(let i of n){let r=e[i];if(r&&(typeof r=="string"||typeof r=="number")){let o=new Date(r);if(!isNaN(o.getTime()))return o}}return null}normalizeTraining=e=>{let n=e??{},i=this.normalizeId(n);return b({id:i,title:String(n.title??n.name??"Treinamento"),description:n.description??null,author:n.author??null,entityType:n.entityType??n.format??n.type??null,publicationStatus:n.publicationStatus??n.status??null,coverImageUrl:n.coverImageUrl??n.imageUrl??null,organizationId:n.organizationId??null,updatedAt:n.updatedAt??null},n)};createPlan(e){let n={name:(e.name||"").trim(),description:(e.description||"").trim().slice(0,512),originalPrice:(e.originalPrice||"").trim(),currentPrice:(e.currentPrice||"").trim(),durationInDays:Number(e.durationInDays)||0};return this.api.post("/admin/plans",n)}createSubscription(e){let n={userId:(e.userId||"").trim(),planId:(e.planId||"").trim()};return this.api.post("/admin/subscriptions",n)}normalizeSector=e=>{let n=e??{},i=this.normalizeId(n);return b({id:i,name:String(n.name??n.title??n.label??"Setor")},n)};normalizeId(e){let n=e.id??e.uuid??e.code??e.slug??e.trainingId;return n!=null?String(n):`admin-${Math.random().toString(36).slice(2,11)}`}unwrapList(e){if(Array.isArray(e))return e;if(e&&typeof e=="object"){let n=e.items??e.data??e.content;if(Array.isArray(n))return n}return[]}normalizeUser(e){if(!e)return{id:"",email:"",enabled:!1};let n=String(e.id??e.userId??e._id??""),i=String(e.email??e.userEmail??""),r=e.role??e.systemRole??null,o=e.enabled!==!1;return b({id:n,email:i,role:r,enabled:o},e)}normalizeOrganization(e){let n=e||{},i=String(n.id??n.orgId??n._id??""),r=String(n.razaoSocial??n.companyName??n.name??n.title??""),o=n.cnpj??n.CNPJ??null,t;if(n.enabled===!0)t=!0;else if(n.enabled===!1)t=!1;else if(typeof n.status=="string"){let p=n.status.toLowerCase();t=p==="active"||p==="enabled"||p==="true"}else if(typeof n.active=="boolean")t=n.active;else if(typeof n.state=="string"){let p=n.state.toLowerCase();t=p==="active"||p==="enabled"}else t=!0;let c=typeof n.memberCount=="number"?n.memberCount:Array.isArray(n.members)?n.members.length:void 0;return b({id:i,name:r,cnpj:o,enabled:t,memberCount:c},n)}searchPdfInNested(e,n=0){if(!e||n>1)return!1;for(let i of Object.values(e))if(typeof i=="string"&&/\.pdf($|\?)/i.test(i)||i&&typeof i=="object"&&!Array.isArray(i)&&this.searchPdfInNested(i,n+1))return!0;return!1}static \u0275fac=function(n){return new(n||v)(U(O),U(R))};static \u0275prov=E({token:v,factory:v.\u0275fac,providedIn:"root"})};export{z as a};
