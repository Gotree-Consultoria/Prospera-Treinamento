import{e as z}from"./chunk-4WPZJNDW.js";import{a as v}from"./chunk-QH4O4DEC.js";import{J as S,L as l,O as b,S as d,a as c,b as g,k as p,n as y,o as h,r as f,z as R}from"./chunk-REX2TJ7H.js";var M=class m{constructor(e,t){this.api=e;this.router=t;this.normalizedSystemRole=this.normalizeRole(this.getStoredRole()),this.getToken()&&this.fetchProfile().subscribe({error:()=>this.clearSession()})}tokenKey="jwtToken";emailKey="loggedInUserEmail";roleKey="systemRole";normalizedSystemRole=null;organizationMemberships=new Map;userSubject=new p(null);user$=this.userSubject.asObservable();isAuthenticated$=this.user$.pipe(f(Boolean));login(e){return this.api.post("/auth/login",e,{withCredentials:!0}).pipe(l(t=>this.persistSession(t)),S(t=>{if(t.profile||t.user){let r=t.profile||t.user,i=this.enrichProfile(r,t.email??e.email);return this.userSubject.next(i),this.syncRoleCaches(i),y(this.userSubject.value)}return this.fetchProfile({suppressNavigation:!0})}))}register(e){return this.api.post("/auth/register",e)}logout(){this.clearSession(),this.router.navigate(["/"])}hasRole(e){let t=this.normalizeRole(e);return t?this.hasSystemRole(t)?!0:this.hasOrganizationRole(t):!1}fetchProfile(e={}){return this.getToken()?this.api.get("/profile/me").pipe(l(r=>{let i=this.enrichProfile(r);this.userSubject.next(i),this.syncRoleCaches(i)}),R(r=>(this.clearSession(),e.suppressNavigation||this.router.navigate(["/"]),h(()=>r)))):h(()=>new Error("Token ausente."))}updateProfile(e){return this.api.post("/profile/pf",e).pipe(f(t=>{let r=this.userSubject.value;return t?this.enrichProfile(t,void 0,r):this.enrichProfile(r??{},void 0,r)}),l(t=>{this.userSubject.next(t),this.syncRoleCaches(t)}))}updatePassword(e,t){let r=t?{oldPassword:t,password:e}:{password:e};return this.api.patch("/profile/password",r)}isAuthenticated(){return!!this.userSubject.value&&!!this.getToken()}getToken(){try{return localStorage.getItem(this.tokenKey)}catch{return null}}getStoredEmail(){try{return localStorage.getItem(this.emailKey)}catch{return null}}getRole(){if(this.normalizedSystemRole)return this.normalizedSystemRole;let e=this.getStoredRole(),t=this.normalizeRole(e);return t&&this.isSystemRoleValue(t),t}getSystemRole(){return this.normalizedSystemRole}hasSystemRole(e){let t=this.normalizeRole(e);return t?this.normalizedSystemRole===t:!1}isSystemAdmin(){return this.hasSystemRole("SYSTEM_ADMIN")}hasOrganizationRole(e,t){let r=this.normalizeRole(e);if(!r)return!1;if(r==="ORG_ADMIN"&&this.hasSystemRole("SYSTEM_ADMIN")||r==="ORG_MEMBER"&&this.hasSystemRole("SYSTEM_ADMIN"))return!0;if(t){let o=this.organizationMemberships.get(String(t));if(o)return!!(o.role===r||r==="ORG_MEMBER"&&o.role==="MEMBER"||r==="ORG_MEMBER"&&o.role==="ORG_ADMIN"||r==="ORG_ADMIN"&&this.isSystemRoleValue(o.role))}for(let o of this.organizationMemberships.values())if(o.role===r||r==="ORG_MEMBER"&&o.role==="MEMBER"||r==="ORG_MEMBER"&&o.role==="ORG_ADMIN"||r==="ORG_ADMIN"&&this.isSystemRoleValue(o.role))return!0;let i=this.collectNormalizedRolesFromProfile(this.userSubject.value);if(i.includes(r)||r==="ORG_MEMBER"&&i.includes("MEMBER")||r==="ORG_ADMIN"&&(i.includes("ADMIN")||i.includes("SYSTEM_ADMIN")))return!0;try{if(r==="ORG_ADMIN"&&sessionStorage.getItem("isCompanyAdmin")==="true"||r==="ORG_MEMBER"&&sessionStorage.getItem("hasMembership")==="true")return!0}catch{}return!1}isOrgAdmin(e){return this.hasOrganizationRole("ORG_ADMIN",e)}isOrgMember(e){return this.hasOrganizationRole("ORG_MEMBER",e)||this.hasOrganizationRole("MEMBER",e)}getOrganizationMemberships(){return Array.from(this.organizationMemberships.values())}getOrganizations(){let e=this.userSubject.value?.organizations;return Array.isArray(e)?e:[]}persistSession(e){if(e?.token)try{localStorage.setItem(this.tokenKey,e.token);let t=e.email??e.profile?.email??e.user?.email??this.userSubject.value?.email;t&&localStorage.setItem(this.emailKey,t);let r=this.extractSystemRoleFromResponse(e);r&&(localStorage.setItem(this.roleKey,r),this.normalizedSystemRole=r)}catch(t){console.warn("[AuthService] n\xE3o foi poss\xEDvel persistir a sess\xE3o",t)}}getStoredRole(){try{return localStorage.getItem(this.roleKey)}catch{return null}}clearSession(){try{localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.emailKey),localStorage.removeItem(this.roleKey)}catch(e){console.warn("[AuthService] falha ao limpar sess\xE3o",e)}this.clearOrganizationFlags(),this.organizationMemberships.clear(),this.normalizedSystemRole=null,this.userSubject.next(null)}enrichProfile(e,t,r){let i=r??this.userSubject.value??null,o=e??{},s=o.email??t??i?.email??this.getStoredEmail()??"",n=g(c(c({},i??{}),o),{email:s});return!o.organizations&&i?.organizations&&(n.organizations=i.organizations),!o.company&&i?.company&&(n.company=i.company),!o.personalProfile&&i?.personalProfile&&(n.personalProfile=i.personalProfile),!o.profile&&i?.profile&&(n.profile=i.profile),n}syncRoleCaches(e){let t=this.resolveSystemRole(e);if(t){this.normalizedSystemRole=t;try{localStorage.setItem(this.roleKey,t)}catch(i){console.warn("[AuthService] n\xE3o foi poss\xEDvel armazenar systemRole",i)}}else{this.normalizedSystemRole=null;try{localStorage.removeItem(this.roleKey)}catch(i){console.warn("[AuthService] n\xE3o foi poss\xEDvel limpar systemRole",i)}}let r=this.collectOrganizationMemberships(e);this.clearOrganizationFlags(),this.organizationMemberships.clear(),r.forEach(i=>this.organizationMemberships.set(i.id,i)),this.persistOrganizationFlags(r)}resolveSystemRole(e){if(!e){let i=this.normalizeRole(this.getStoredRole());return i&&this.isSystemRoleValue(i)?i:null}let t=[e?.systemRole,e.role,e?.roles,e?.authorities,e?.permissions,e?.profile?.systemRole,e?.profile?.role,e?.profile?.roles,e?.profile?.authorities,e?.profile?.permissions,e?.personalProfile?.systemRole,e?.personalProfile?.role,e?.personalProfile?.roles,e?.personalProfile?.authorities,e?.personalProfile?.permissions,e?.company?.role,e?.company?.roles,e?.company?.authorities],r=new WeakSet;for(let i of t){let s=Array.from(this.extractNormalizedRoles(i,r)).find(n=>this.isSystemRoleValue(n));if(s)return s}return null}collectOrganizationMemberships(e){let t=Array.isArray(e?.organizations)?e.organizations:[],r=[];for(let i of t){if(!i||typeof i!="object")continue;let o=i,s=this.extractOrganizationId(o);if(!s)continue;let n=this.extractOrganizationRole(o);n&&r.push({id:s,role:n,name:this.extractOrganizationName(o),membershipId:this.extractOrganizationMembershipId(o)})}return r}extractOrganizationId(e){let t=[e.organizationId,e.organization_id,e.orgId,e.org_id,e.id,e._id,e.uuid,e.code,e.slug];for(let r of t)if(r!=null&&r!=="")return String(r);return null}extractOrganizationRole(e){let t=[e.yourRole,e.your_role,e.role,e.userRole,e.membershipRole,e.membership_role];for(let r of t){let i=this.normalizeRole(r);if(i&&!this.isSystemRoleValue(i))return i}return null}extractOrganizationMembershipId(e){let t=[e.membershipId,e.membership_id,e.membership,e.membershipid];for(let r of t)if(r!=null&&r!=="")return String(r)}extractOrganizationName(e){let t=[e.organizationName,e.name,e.companyName,e.razaoSocial,e.legalName];for(let r of t)if(r!=null&&r!=="")return String(r)}persistOrganizationFlags(e){let t=!1;for(let r of e){(r.role==="ORG_ADMIN"||r.role==="ADMIN"||r.role==="SYSTEM_ADMIN")&&(t=!0);try{sessionStorage.setItem(`myOrgRole_${r.id}`,r.role)}catch{}if(r.membershipId)try{sessionStorage.setItem(`myMembershipId_${r.id}`,r.membershipId)}catch{}if(r.name)try{sessionStorage.setItem(`orgName_${r.id}`,r.name)}catch{}}try{e.length>0?sessionStorage.setItem("hasMembership","true"):sessionStorage.removeItem("hasMembership")}catch{}try{t?sessionStorage.setItem("isCompanyAdmin","true"):sessionStorage.removeItem("isCompanyAdmin")}catch{}}clearOrganizationFlags(){for(let e of this.organizationMemberships.values())try{sessionStorage.removeItem(`myOrgRole_${e.id}`),sessionStorage.removeItem(`myMembershipId_${e.id}`),sessionStorage.removeItem(`orgName_${e.id}`)}catch{}try{sessionStorage.removeItem("hasMembership"),sessionStorage.removeItem("isCompanyAdmin"),sessionStorage.removeItem("currentOrganizationId"),sessionStorage.removeItem("currentOrganizationName")}catch{}}normalizeRole(e){if(e==null)return null;if(Array.isArray(e)){for(let r of e){let i=this.normalizeRole(r);if(i)return i}return null}let t=String(e).trim();return t?t.toUpperCase().replace(/[^A-Z0-9]+/g,"_").replace(/^_+|_+$/g,""):null}isSystemRoleValue(e){return e?e==="SYSTEM_ADMIN"||e==="ADMIN"||e.startsWith("SYSTEM_"):!1}collectNormalizedRolesFromProfile(e){if(!e)return[];let t=new WeakSet,r=new Set,i=[e,e.company,e.personalProfile,e.profile,e.organizations];for(let o of i)for(let s of this.extractNormalizedRoles(o,t))r.add(s);return Array.from(r)}extractNormalizedRoles(e,t){let r=new Set;if(!e)return r;if(typeof e=="string"){let o=this.normalizeRole(e);return o&&r.add(o),r}if(Array.isArray(e)){for(let o of e)for(let s of this.extractNormalizedRoles(o,t))r.add(s);return r}if(typeof e=="object"){let o=e;if(t.has(o))return r;t.add(o);let s=["role","systemRole","system_role","yourRole","your_role","membershipRole","membership_role","userRole","orgRole","org_role","roleName","role_name","companyRole","membershipRoles","roles","authorities","permissions","position"];for(let a of s)if(a in o)for(let u of this.extractNormalizedRoles(o[a],t))r.add(u);let n=["profile","personalProfile","company","organization","organizationInfo"];for(let a of n)if(a in o)for(let u of this.extractNormalizedRoles(o[a],t))r.add(u);if("organizations"in o)for(let a of this.extractNormalizedRoles(o.organizations,t))r.add(a);if("memberships"in o)for(let a of this.extractNormalizedRoles(o.memberships,t))r.add(a);if("membership"in o)for(let a of this.extractNormalizedRoles(o.membership,t))r.add(a);return r}let i=this.normalizeRole(e);return i&&r.add(i),r}extractSystemRoleFromResponse(e){if(!e)return null;let t=[e.role,e.profile?.systemRole,e.user?.systemRole,e.profile?.role,e.user?.role,e.profile?.roles,e.profile?.authorities,e.profile?.permissions,e.user?.roles,e.user?.authorities,e.user?.permissions],r=new WeakSet;for(let i of t){let s=Array.from(this.extractNormalizedRoles(i,r)).find(n=>this.isSystemRoleValue(n));if(s)return s}return null}static \u0275fac=function(t){return new(t||m)(d(v),d(z))};static \u0275prov=b({token:m,factory:m.\u0275fac,providedIn:"root"})};export{M as a};
