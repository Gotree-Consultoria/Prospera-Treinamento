<section class="account-page" *ngIf="!isLoading; else loading">
  <div class="container">
    <aside class="account-sidebar" *ngIf="user">
      <div class="user-summary">
        <div>
          <p class="user-name">{{ displayName }}</p>
          <p class="user-email">{{ displayEmail }}</p>
        </div>
      </div>

      <div class="user-status">
        <span class="badge" [class.badge-warning]="!isProfileComplete">
          {{ isProfileComplete ? 'Perfil completo' : 'Complete seu perfil' }}
        </span>
      </div>

      <nav class="account-menu" aria-label="Seções da conta">
        <button
          type="button"
          *ngFor="let item of menuItems"
          (click)="selectSection(item.id)"
          [class.active]="activeSection === item.id"
        >
          <i [class]="item.icon" aria-hidden="true"></i>
          {{ item.label }}
        </button>
      </nav>

      <button type="button" class="btn btn-secondary logout" (click)="logout()">
        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
        Sair da conta
      </button>
    </aside>

    <main class="account-content" *ngIf="user">
      <ng-container [ngSwitch]="activeSection">
        <section *ngSwitchCase="'profile'" class="profile-section">
          <header class="section-header">
            <h1>Minha conta</h1>
            <p>Atualize seus dados, acompanhe o status de pagamento e administre a empresa.</p>
          </header>

          <div class="profile-tabs" role="tablist">
            <button
              type="button"
              *ngFor="let section of availableProfileSections"
              role="tab"
              [attr.aria-selected]="activeProfileTab === section.id"
              [class.active]="activeProfileTab === section.id"
              (click)="selectProfileTab(section.id)"
            >
              {{ section.label }}
            </button>
          </div>

          <div class="profile-panel" [ngSwitch]="activeProfileTab">
            <div *ngSwitchCase="'dados'" class="grid">
              <article class="card primary">
                <header>
                  <h2>Dados principais</h2>
                  <span class="status" [class.status-warning]="!isProfileComplete">
                    {{ isProfileComplete ? 'Completo' : 'Incompleto' }}
                  </span>
                </header>
                <dl>
                  <div>
                    <dt>Nome completo</dt>
                    <dd>{{ displayName }}</dd>
                  </div>
                  <div>
                    <dt>E-mail</dt>
                    <dd>{{ displayEmail }}</dd>
                  </div>
                  <div>
                    <dt>CPF</dt>
                    <dd>{{ displayCPF }}</dd>
                  </div>
                  <div>
                    <dt>Data de nascimento</dt>
                    <dd>{{ displayBirth }}</dd>
                  </div>
                  <div>
                    <dt>Telefone</dt>
                    <dd>{{ displayPhone }}</dd>
                  </div>
                </dl>
                <footer>
                  <button type="button" class="btn btn-link" (click)="toggleProfileEdit()">
                    <i class="fas fa-edit" aria-hidden="true"></i>
                    {{ isEditingProfile ? 'Cancelar edição' : 'Editar dados' }}
                  </button>
                </footer>
              </article>

              <article class="card" *ngIf="isEditingProfile">
                <header>
                  <h2>Atualizar dados pessoais</h2>
                </header>
                <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="form-grid">
                  <label>
                    <span>Nome completo</span>
                    <input type="text" formControlName="name" placeholder="Como devemos chamar você?" />
                    <small class="field-error" *ngIf="profileForm.get('name')?.invalid && profileForm.get('name')?.touched">
                      Informe um nome com pelo menos 3 caracteres.
                    </small>
                  </label>
                  <label>
                    <span>CPF</span>
                    <input type="text" formControlName="cpf" placeholder="000.000.000-00" />
                    <small class="field-error" *ngIf="profileForm.get('cpf')?.invalid && profileForm.get('cpf')?.touched">
                      Informe um CPF válido.
                    </small>
                  </label>
                  <label>
                    <span>Telefone</span>
                    <input type="tel" formControlName="phone" placeholder="(00) 00000-0000" />
                  </label>
                  <label>
                    <span>Data de nascimento</span>
                    <input type="date" formControlName="birth" />
                  </label>
                  <div class="form-actions">
                    <button class="btn btn-primary" type="submit" [disabled]="isSaving">
                      {{ isSaving ? 'Salvando…' : 'Salvar alterações' }}
                    </button>
                  </div>
                  <div class="form-messages">
                    <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
                    <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>
                  </div>
                </form>
              </article>
            </div>

            <article *ngSwitchCase="'payments'" class="card stretch">
              <header>
                <h2>Status da assinatura</h2>
                <span class="tag">{{ companyPlan }}</span>
              </header>
              <div class="subscription">
                <p><strong>Situação:</strong> Ativa</p>
                <p><strong>Próxima renovação:</strong> 12/12/2024</p>
                <p><strong>Forma de pagamento:</strong> Cartão de crédito final **42</p>
              </div>

              <section class="invoices">
                <h3>Faturas anteriores</h3>
                <ul>
                  <li>
                    <span>Novembro/2024</span>
                    <span>Pago</span>
                    <a href="#" (click)="$event.preventDefault()">Baixar recibo</a>
                  </li>
                  <li>
                    <span>Outubro/2024</span>
                    <span>Pago</span>
                    <a href="#" (click)="$event.preventDefault()">Baixar recibo</a>
                  </li>
                </ul>
              </section>
            </article>

            <article *ngSwitchCase="'password'" class="card stretch">
              <header>
                <h2>Trocar senha</h2>
                <p>Garanta que sua senha seja forte e atualizada regularmente.</p>
              </header>
              <form [formGroup]="passwordForm" (ngSubmit)="savePassword()" class="form-grid">
                <label>
                  <span>Senha atual</span>
                  <input type="password" formControlName="currentPassword" placeholder="Digite sua senha atual" />
                </label>
                <label>
                  <span>Nova senha</span>
                  <input type="password" formControlName="newPassword" placeholder="Nova senha (mínimo de 6 caracteres)" />
                  <small class="field-error" *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
                    Informe uma senha com pelo menos 6 caracteres.
                  </small>
                </label>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit">Atualizar senha</button>
                </div>
                <div class="form-messages">
                  <p class="success" *ngIf="passwordSuccessMessage">{{ passwordSuccessMessage }}</p>
                  <p class="error" *ngIf="passwordErrorMessage">{{ passwordErrorMessage }}</p>
                </div>
              </form>
            </article>

            <ng-container *ngSwitchCase="'company'">
              <ng-container *ngTemplateOutlet="companyManagement"></ng-container>
            </ng-container>
          </div>
        </section>

        <section *ngSwitchCase="'plans'" class="card stretch">
          <header>
            <h1>Planos & Assinatura</h1>
            <p>Informações da sua assinatura atual.</p>
          </header>

          <div class="loading" *ngIf="subscriptionLoading">
            <span class="spinner" aria-hidden="true"></span>
            <p>Carregando assinatura…</p>
          </div>

          <div class="error" *ngIf="!subscriptionLoading && subscriptionError">
            <p>{{ subscriptionError }}</p>
            <button class="btn btn-secondary" (click)="loadMySubscription(true)">Tentar novamente</button>
          </div>

          <div *ngIf="!subscriptionLoading && subscription === null" class="empty">
            <p>Você ainda não possui uma assinatura ativa.</p>
            <a routerLink="/planos" class="btn btn-primary">Ver Planos</a>
          </div>

          <div *ngIf="!subscriptionLoading && subscription as sub" class="subscription-details card">
            <div class="sub-grid">
              <div class="sub-main">
                <h2 class="plan-name">{{ sub.planName }}</h2>
                <div class="meta-row">
                  <span class="status-tag">{{ humanStatus(sub.status) }}</span>
                  <span class="origin-tag">{{ originLabel(sub.origin) }}</span>
                </div>
                <p *ngIf="sub.description" class="plan-desc">{{ sub.description }}</p>
                <div class="price-row" *ngIf="sub.currentPrice || sub.originalPrice">
                  <span class="price-current">{{ formatPrice(sub.currentPrice) }}</span>
                  <span class="price-old" *ngIf="sub.originalPrice">{{ formatPrice(sub.originalPrice) }}</span>
                  <span class="duration" *ngIf="sub.durationInDays">• {{ durationLabel(sub.durationInDays) }}</span>
                </div>
              </div>
              <aside class="sub-side">
                <dl>
                  <div *ngIf="sub.startedAt">
                    <dt>Início</dt>
                    <dd>{{ sub.startedAt | date:'shortDate' }}</dd>
                  </div>
                  <div *ngIf="sub.expiresAt">
                    <dt>Fim</dt>
                    <dd>{{ sub.expiresAt | date:'shortDate' }}</dd>
                  </div>
                  <div *ngIf="sub.origin">
                    <dt>Origem</dt>
                    <dd>{{ originLabel(sub.origin) }}</dd>
                  </div>
                </dl>
                <div class="actions"></div>
              </aside>
            </div>
          </div>
        </section>

        <ng-container *ngSwitchCase="'manageCompanies'">
          <ng-container *ngTemplateOutlet="companyManagement"></ng-container>
        </ng-container>

        <section *ngSwitchCase="'learning'" class="card stretch">
          <header>
            <h1>Cursos & Treinamentos</h1>
            <p>Centralize o acompanhamento da jornada de aprendizagem da sua empresa.</p>
          </header>
          <div class="learning-body">
            <article class="learning-card">
              <h2>Biblioteca Prospera</h2>
              <p>Acesse todos os cursos disponíveis para o seu plano, organize trilhas e acompanhe certificados.</p>
              <button type="button" class="btn btn-primary" (click)="openLearningCatalog()">Ir para a biblioteca</button>
            </article>
            <article class="learning-card">
              <h2>Organizações vinculadas</h2>
              <ul>
                <li *ngFor="let org of user?.organizations || []">{{ org['organizationName'] || org['name'] }} — {{ org['position'] || 'Membro' }}</li>
              </ul>
              <p *ngIf="!(user?.organizations?.length)">Você ainda não está vinculado a nenhuma organização. Entre em contato com um administrador.</p>
            </article>
          </div>
        </section>
      </ng-container>
    </main>
  </div>
</section>

<ng-template #companyManagement>
  <article class="card stretch">
    <header>
      <div>
        <h2>Gestão da empresa</h2>
        <p>Adicione e gerencie organizações sob sua conta.</p>
        <!-- formulário inline removido: usar apenas o modal para criação de organizações -->
        <div class="org-create-cta">
          <button class="btn btn-primary" type="button" (click)="openCreateOrgModal()">Adicionar empresa</button>
        </div>
      </div>
      <div class="company-meta">
        <p><strong>Sua conta</strong></p>
      </div>
    </header>
    <!-- Modal: criar organização -->
    <div class="modal-backdrop" *ngIf="showOrgModal">
      <div class="modal" role="dialog" aria-modal="true" aria-label="Adicionar empresa">
          <div class="modal-header">
            <h3>Adicionar empresa</h3>
          </div>
        <form [formGroup]="orgCreateForm" (ngSubmit)="createOrganizationFromModal()" novalidate>
          <label>
            <span>CNPJ</span>
            <input type="text" formControlName="cnpj" placeholder="00.000.000/0000-00" (input)="onCnpjInput()" (blur)="triggerCnpjLookup()" />
          </label>
          <label>
            <span>Razão social</span>
            <input type="text" formControlName="razaoSocial" placeholder="Razão social (preenchimento automático via CNPJ)" />
          </label>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="closeCreateOrgModal()" [disabled]="isCreatingOrg">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="isCreatingOrg">{{ isCreatingOrg ? 'Adicionando…' : 'Adicionar empresa' }}</button>
          </div>
          <p class="info" *ngIf="lookupInProgress">Buscando razão social pelo CNPJ…</p>
          <p class="error" *ngIf="lookupError">{{ lookupError }}</p>
        </form>
      </div>
    </div>
    

    <!-- company-tabs removido: usamos somente a view de Usuários dentro da gestão de empresas -->

  <div class="company-panel">
    <div class="company-users">
        <h3>Suas Organizações</h3>
        <div *ngIf="orgsLoading">Carregando organizações…</div>
        <div class="org-cards" *ngIf="!orgsLoading">
          <article *ngFor="let org of organizations" class="org-card" [class.selected]="selectedOrgId === org.id" (click)="selectOrganization(org.id)">
            <h4>{{ org.name }}</h4>
            <p class="small">CNPJ: {{ org.cnpj || '—' }}</p>
          </article>
        </div>
        <div *ngIf="!orgsLoading && organizations.length === 0" class="empty">Nenhuma organização encontrada.</div>

        <div *ngIf="selectedOrgId" class="org-detail card">
          <header>
            <h3>Organização selecionada</h3>
            <p *ngIf="organizations.length">{{ selectedOrgName }}</p>
          </header>
          <!-- reutilizamos a área de membros já implementada -->
          <div class="org-members">
            <h4>Membros</h4>
            <div *ngIf="orgMembersLoading">Carregando membros…</div>
            <table *ngIf="!orgMembersLoading && orgMembers.length">
              <thead>
                <tr><th>Nome</th><th>E-mail</th><th>Role</th><th>Ações</th></tr>
              </thead>
              <tbody>
                <tr *ngFor="let m of orgMembers" (click)="openMemberMenuId = null">
                  <td>{{ m.fullName || '—' }}</td>
                  <td>{{ m.userEmail || '—' }}</td>
                    <td>{{ m.role === 'ORG_ADMIN' ? 'Administrador' : 'Membro' }}</td>
                  <td class="actions-cell">
                    <div class="action-menu-wrapper">
                                  <button class="btn btn-icon" (click)="toggleMemberMenu(m.membershipId, $event)" aria-haspopup="true" [attr.aria-expanded]="openMemberMenuId === m.membershipId ? 'true' : 'false'">⋯</button>
                                  <div class="action-menu" *ngIf="openMemberMenuId === m.membershipId" (click)="$event.stopPropagation()" role="menu" aria-label="Ações do membro">
                                    <div class="action-item" role="menuitem" (click)="toggleMemberRole(m.membershipId, m.role); $event.stopPropagation()">
                                      <span class="icon" aria-hidden>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                          <path d="M12 20h9" />
                                          <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
                                        </svg>
                                      </span>
                                      <span class="action-text">{{ m.role === 'ORG_ADMIN' ? 'Mudar para Membro' : 'Mudar para Administrador' }}</span>
                                    </div>
                                    <div class="action-item" role="menuitem" (click)="viewMemberProgress(m.membershipId); $event.stopPropagation()">
                                      <span class="icon" aria-hidden>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                          <path d="M3 3v18h18" />
                                          <path d="M3 9h18" />
                                          <path d="M7 12v6" />
                                          <path d="M12 6v12" />
                                          <path d="M17 14v4" />
                                        </svg>
                                      </span>
                                      <span class="action-text">Ver Progresso</span>
                                    </div>
                                    <div class="action-item danger" role="menuitem" (click)="confirmRemoveMember(m.membershipId); $event.stopPropagation()">
                                      <span class="icon" aria-hidden>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                                          <polyline points="3 6 5 6 21 6" />
                                          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                                          <path d="M10 11v6" />
                                          <path d="M14 11v6" />
                                          <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" />
                                        </svg>
                                      </span>
                                      <span class="action-text">Remover</span>
                                    </div>
                                  </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Modal de confirmação para remoção de membro -->
            <div *ngIf="removingMemberId" class="modal-backdrop" (click)="cancelRemoveMember()">
              <div class="modal" role="dialog" aria-modal="true" aria-labelledby="remove-member-title" (click)="$event.stopPropagation()">
                <div class="modal-header">
                  <h3 id="remove-member-title">Remover membro</h3>
                </div>
                <div class="modal-body">
                  <p>Tem certeza que deseja remover este membro da organização? Esta ação não pode ser desfeita.</p>
                  <div *ngIf="removeMemberError" class="error">{{ removeMemberError }}</div>
                  <div *ngIf="removeMemberSuccessMessage" class="muted">{{ removeMemberSuccessMessage }}</div>
                </div>
                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" (click)="cancelRemoveMember()" [disabled]="removeMemberLoading">Cancelar</button>
                  <button type="button" class="btn btn--danger" (click)="proceedRemoveMember()" [disabled]="removeMemberLoading">{{ removeMemberLoading ? 'Removendo…' : 'Remover' }}</button>
                </div>
              </div>
            </div>

              <div class="org-actions">
              <form class="invite-form invite-row" [formGroup]="inviteForm" (ngSubmit)="inviteSubuser()">
                <label class="invite-email">
                  <span class="sr-only">Adicionar membro por e-mail</span>
                  <input type="email" formControlName="email" placeholder="colaborador@empresa.com" />
                </label>
                <label class="invite-role">
                  <span class="sr-only">Role</span>
                  <select formControlName="role" aria-label="Role do membro">
                    <option value="ORG_ADMIN">Administrador</option>
                    <option value="ORG_MEMBER">Membro</option>
                  </select>
                </label>
                <div class="invite-actions">
                  <button type="submit" class="btn btn-primary" [disabled]="isAddingMember">{{ isAddingMember ? 'Adicionando…' : 'Adicionar Membro' }}</button>
                </div>
              </form>
              <div class="invite-messages">
                <p class="success" *ngIf="inviteSuccessMessage">{{ inviteSuccessMessage }}</p>
                <p class="error" *ngIf="inviteErrorMessage">{{ inviteErrorMessage }}</p>
              </div>
              <!-- import/report actions removidas -->
            </div>
          </div>
        </div>
  <!-- título removido: redundante com a listagem de organizações -->

        <div *ngIf="orgMembersLoading" class="loading">Carregando membros…</div>
        <div *ngIf="!orgMembersLoading && orgMembersError" class="error">{{ orgMembersError }}</div>
      </div>

      <!-- import/reports views removidas -->
    </div>
  </article>
</ng-template>

<!-- Member Progress Modal -->
<div *ngIf="viewingProgressFor" class="modal-backdrop" (click)="closeMemberProgress()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Progresso do membro</h3>
    </div>
    <div class="modal-body">
      <div *ngIf="memberProgressLoading">Carregando progresso…</div>
      <div *ngIf="memberProgressError" class="error">{{ memberProgressError }}</div>
      <div *ngIf="!memberProgressLoading && memberProgressList.length">
        <div class="progress-list">
          <article *ngFor="let p of memberProgressList" class="progress-item">
            <img *ngIf="p.coverImageUrl" class="progress-cover portrait" [src]="p.coverImageUrl" alt="{{ p.trainingTitle || 'Capa do conteúdo' }}" title="{{ p.trainingTitle || 'Capa do conteúdo' }}" />
            <div class="progress-content">
              <h4 class="title">{{ p.trainingTitle }}</h4>
              <div class="meta">Status: {{ displayStatus(p.status) }} • Matrícula: {{ p.enrolledAt | date:'dd/MM/yyyy' }}</div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="p.progressPercentage || 0"></div>
              </div>
              <div class="progress-percent">{{ (p.progressPercentage || 0) | number:'1.0-2' }}%</div>
            </div>
          </article>
        </div>
      </div>
      <div *ngIf="!memberProgressLoading && !memberProgressList.length && !memberProgressError">Nenhum progresso encontrado.</div>
    </div>
    <div class="form-actions">
      <button class="btn btn-secondary" (click)="closeMemberProgress()">Fechar</button>
    </div>
  </div>
</div>

<ng-template #loading>
  <div class="loading-state">
    <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
    <p>Carregando seus dados…</p>
  </div>
</ng-template>
